#!/bin/bash

set -x
set -e

VERSION_SH="https://github.build.ge.com/raw/adoption/Org-migration/master/version.sh"

echo -n "Reading version... "
VERSION=$(eval "$(curl -s -L $VERSION_SH)")
echo $VERSION

if [[ -f version.json ]] && [[ ! -z "$1" ]] ; then
  #handle a repo referencing itself to set the tag that is about to be created
  echo "dollar-one=$1"
  cat version.json
  sed -i -e 's/'"$1"'#.*\"/'"$1"'#'"$VERSION"'\"/g' version.json
  cat version.json
fi

git status
if [ -n "$(git status --untracked-files=no --porcelain)" ]; then
  echo "commiting"
  echo `git commit -a -m "Release $VERSION"`
else
  echo "nothing to commit"
fi

echo "Tagging release... with $VERSION "
git tag -f $VERSION
echo $?

echo "running git push --set-upstream origin master"
#in echo in case nothing to commit
echo `git push -f --set-upstream origin master`

git checkout develop
git status
git commit --allow-empty -am "Release $VERSION"
#in echo in case nothing to commit
echo `git push -f --set-upstream origin develop`

git checkout master

git push -f --tags


