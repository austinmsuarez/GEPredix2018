#!/bin/bash
#export MAVEN_OPTS="-Dmaven.repo.local=/opt/jenkins_build/workspace/Predix-Adoption/repository"
set -x
set -e
pwd

#build so it resolves dependent jars
echo dollarone=$1
echo dollartwo=$2


mvn clean compile -B -s "$1/library/scripts/mvn_settings_snapshot_with_external.xml"

#update the dependency versions
mvn versions:update-properties -B -Dincludes=com.ge.predix.solsvc,com.ge.predix.eventhub -DallowSnapshots=true -s $1/library/scripts/mvn_settings_snapshot_only.xml -Dartifactory.password=$DEVCLOUD_ARTIFACTORY_PASSWORD > update-properties.log
cat update-properties.log

#make sure it didn't skip any
if grep -q "Leaving unchanged" update-properties.log | grep -q "SNAPSHOT"
then
    echo "Found 'Leaving unchanged', property was not updated"
    grep "Leaving unchanged" update-properties.log
    exit 1
fi

echo "deploy to artifactory so the next job can find it"
mvn -DskipTests -B -DaltDeploymentRepository=artifactory.snapshots::default::https://devcloud.swcoe.ge.com/artifactory/PREDIX-SNAPSHOT -DaltSnapshotDeploymentRepository=artifactory.snapshots::default::https://devcloud.swcoe.ge.com/artifactory/PREDIX-SNAPSHOT deploy -U -s $1/library/scripts/mvn_settings_snapshot_with_external.xml 
echo "mvn deploy complete"
