#!groovy

/**
  * javascript build 
  *@param useInternalNpmRepo 
  **/
def buildJS(useInternalNpmRepo) {
   if (fileExists('package.json')) {
     npmInstall(useInternalNpmRepo)
   }
   if (fileExists('bower.json')) {
     bowerInstall()
   }
   if (fileExists('gulpfile.js')) {
     gulpInstall()
   }
} 

/**
  * npm install 
  *@param useInternalNpmRepo - directory Name 
  **/
def npmInstall(useInternalNpmRepo) {
  def registry = "https://registry.npmjs.org"
  if (useInternalNpmRepo == true || useInternalNpmRepo == "true") {
    registry = "http://nexus.marathon.l4lb.thisdcos.directory:8081/nexus/repository/npm-remote/"
  }
  sh """
    set -x
    set -e
    # npm cache clean --force
    npm config set strict-ssl false
    npm config set registry ${registry}
    npm config ls
    npm install
    testsFound=`cat package.json | grep -E "test" | wc -l`
    echo "testsFound=\$testsFound"
    if [ "\$testsFound" -gt "0" ]; then
      npm test
    fi
  """
} 


/**
  * npm install from npmjs.com
  *@param repoName - repository name 
  **/
def npmInstallFromNpmJsCom(repoName) {
  sh """
    set -x
    set -e
    # npm cache clean --force
    cd /tmp
    sudo -u predix npm install ${repoName}
    pwd
  """
} 

/**
  * bower install   
  **/
def bowerInstall(deprecated) {
  echo "bowerInstall(arg) is DEPRECATED.  no argument needed.  Just call bowerInstall()"
  bowerInstall()
}

def bowerInstall() {
  sh """
    set -x
    set -e
    whoami
    chmod -R 777 .
    chown -R predix:not-root .
    #bower --allow-root cache clean && bower --allow-root install
    sudo -u predix bower cache clean
    sudo -u predix bower install
    #sudo -u predix library/scripts/bower.sh
  """  
}

/**
  * gulp dist
  **/
def gulpInstall(deprecated) {
  echo "gulpInstall(arg) is DEPRECATED.  no argument needed.  Just call gulpInstall()"
  gulpInstall()
} 
/**
  * gulp dist
  **/
def gulpInstall() {
  sh """
    set -x
    set -e
    sudo -u predix gulp dist
  """
} 

/**
 * This method will login to npmjs.com and release the project to that public repo
 * Reads from environment vars:  NPM_CREDS
 */
def npmPredixPublish(repoName) {
 echo "inside jsFunctions.npmPredixPublish(${repoName})"
  sh """#!/bin/bash -e
  set -x
  pwd
  git status
  library/scripts/npmPublish.expect ${repoName} ${NPM_CREDS_USR} ${NPM_CREDS_PSW}
  """
}

